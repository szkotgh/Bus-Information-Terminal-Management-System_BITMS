{% extends "base.html" %}

{% block body %}
<style>
    #cpu-usages-list { white-space: nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .cpu-core { display: inline-block; width: 88px; text-align: left; }
</style>
<div class="container">
    <div class="d-flex justify-content-between mb-3">
        <div>
            <h3>단말기 상태 확인</h3>
            <span class="text-muted">실시간으로 BIT의 상태를 확인합니다.</span>
        </div>
        <div class="align-self-end">
        </div>
    </div>
    {% if terminal_list.success %}
        <select class="form-select" aria-label="Default select example" onchange="changeTerminal(this.value)">
            <option value="" selected disabled>단말기를 선택하세요</option>
            {% for terminal in terminal_list.data %}
                <option value="{{ terminal.id }}" {% if terminal.status != 'active' %}disabled{% endif %}>{{ terminal.name }}{% if terminal.status != 'active' %}&#40;사용불가&#41;{% endif %}</option>
            {% endfor %}
        </select>
    {% else %}
        <div class="alert alert-danger">
            {{ terminal_list.message }}
        </div>
    {% endif %}
    <div class="mt-1">
        <div>
            연결상태: <span id="status-label">연결 안됨</span>
        </div>
    </div>
    <hr>
    <div id="terminal-status-info" class="d-flex justify-content-end">
        <span>최초연결:&nbsp;<span id="first-status-time-label"></span>&nbsp;|&nbsp;<span>최종수신:&nbsp;<span id="last-updated-at-label"></span></span>&nbsp;|&nbsp;<span>수신횟수:&nbsp;<span id="status-count-label"></span></span>&nbsp;|&nbsp;<span>TDS:&nbsp;<span id="tds-label"></span></span>
    </div>
    
    <!-- 장치 상태 정보 표시 영역 -->
    <div id="device-status-display" class="bg-light p-2 border rounded">
        <div class="row">
            <div class="col-md-6">
                <h5 class="mb-1">&gt;&nbsp;시스템 정보</h5>
                <div id="system-info" class="mb-3">
                    <p class="mb-1 small">시스템 시작: <span id="start-datetime">-</span></p>
                    <p class="mb-1 small">CPU 사용량: <span id="cpu-usages-list" class="mono">-</span> &#40;<span id="cpu-usage-avg">-</span>&#37;&#41;</p>
                    <div class="progress mb-1" style="height: 2px;">
                        <div class="progress-bar" id="cpu-usage-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="mb-1 small">CPU 온도: <span id="cpu-temp">-</span>°C</p>
                    <div class="progress" style="height: 2px;">
                        <div class="progress-bar" id="cpu-temp-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-1">&gt;&nbsp;네트워크 정보</h5>
                <div id="network-info" class="mb-3">
                    <p class="mb-1 small">연결 타입: <span id="connection-type">-</span>&nbsp;<button class="btn btn-secondary btn-sm me-1" id="internet-test-button" onclick="sendCommandCheck()" disabled>인터넷 테스트</button></p>
                    <p class="mb-1 small">SSID/게이트웨이: <span id="ssid-gateway">-</span></p>
                    <p class="mb-1 small">IP 주소: <span id="ip-address">-</span></p>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <h5 class="mb-1">&gt;&nbsp;디스크 정보</h5>
                <div id="disk-info" class="mb-3">
                    <p class="mb-1 small">사용량: <span id="used-disk">-</span>&nbsp;/&nbsp;<span id="total-disk">-</span> &#40;<span id="disk-usage">-</span>&#37;&#41;</p>
                    <div class="progress" style="height: 2px;">
                        <div class="progress-bar" id="disk-usage-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-1">&gt;&nbsp;메모리 정보</h5>
                <div id="memory-info" class="mb-3">
                    <p class="mb-1 small">사용량: <span id="used-memory">-</span>&nbsp;/&nbsp;<span id="total-memory">-</span> &#40;<span id="memory-usage">-</span>&#37;&#41;</p>
                    <div class="progress" style="height: 2px;">
                        <div class="progress-bar" id="memory-usage-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <h5 class="mb-1">&gt;&nbsp;서비스 정보</h5>
                <div id="service-info" class="mb-3">
                    <!-- service info -->
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-0">&gt;&nbsp;오디오 정보</h5>
                <span class="text-muted small">BIT 프로그램에서 출력되는 오디오는 별개로 설정됩니다.</span>
                <div class="mt-2" id="audio-info" class="mb-3">
                    <p class="mb-1 small">상태: <span id="audio-status">-</span></p>
                    <p class="mb-1 small">재생정보: <span id="audio-current">-</span>&nbsp;<button class="btn btn-sm btn-secondary" id="audio-play-stop-button" onclick="sendCommand('playstop')" disabled>재생중지</button></p>
                    <p class="mb-1 small">볼륨: <span id="audio-volume">-</span>&#37;&nbsp;<button class="btn btn-sm btn-secondary" id="audio-volume-button" onclick="sendCommandVolume()" disabled>볼륨 조절</button></p>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 me-2">장치 제어</h5>
                    <small class="text-muted">선택된 터미널: <span id="selected-terminal-name">없음</span></small>
                </div>
                <div id="device-control" class="mt-1">
                    <button class="btn btn-secondary btn-sm me-1" onclick="sendCommandSpeak()">TTS</button>
                    <button class="btn btn-secondary btn-sm me-1" onclick="sendCommand('bitpservicerestart')">전광판 시작</button>
                    <button class="btn btn-secondary btn-sm me-1" onclick="sendCommand('bitpservicestop')">전광판 종료</button>
                    <button class="btn btn-secondary btn-sm" onclick="sendCommand('restart')">시스템 재시작</button>
                    <button class="btn btn-secondary btn-sm me-1" onclick="sendCommandShutdown()">시스템 종료</button>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock body %}

{% block scripts %}
<script type="text/javascript" src="{{ url_for('static', filename='assets/socket.io.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='assets/filesize.min.js') }}"></script>
<script>
    let selectedTerminalId = '';
    let statusCount = 0;
    let firstStatusTime = '없음';
    let lastUpdatedAt = '없음';
    let tds = 0;
    const statusLabel = document.getElementById('status-label');
    const statusCountLabel = document.getElementById('status-count-label');
    const firstStatusTimeLabel = document.getElementById('first-status-time-label');
    const lastUpdatedAtLabel = document.getElementById('last-updated-at-label');
    const tdsLabel = document.getElementById('tds-label');
    const internetTestButton = document.getElementById('internet-test-button');
    const audioVolumeButton = document.getElementById('audio-volume-button');
    const audioPlayStopButton = document.getElementById('audio-play-stop-button');
    
    const socket = io('/terminal');

    function setStatusLabelText(status) {
        statusLabel.textContent = status;
    }

    function updateProgressBarColor(progressBar, value) {
        progressBar.classList.remove('bg-info', 'bg-primary', 'bg-warning', 'bg-danger');
        
        if (value < 20) {
            progressBar.classList.add('bg-info');
            return
        }

        if (value < 35) {
            progressBar.classList.add('bg-primary');
            return
        }
        
        if (value < 70) {
            progressBar.classList.add('bg-warning');
            return
        }
        
        progressBar.classList.add('bg-danger');
        return
    }

    function updateProgressBar(progressBarId, value) {
        const progressBar = document.getElementById(progressBarId);
        if (progressBar) {
            progressBar.style.width = value + '%';
            progressBar.setAttribute('aria-valuenow', value);
            updateProgressBarColor(progressBar, value);
        }
    }


    function updateServiceInfo(serviceInfo) {
        const serviceContainer = document.getElementById('service-info');
        serviceContainer.innerHTML = '';
        
        if (Array.isArray(serviceInfo) && serviceInfo.length > 0) {
            serviceInfo.forEach((service, index) => {
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'mb-2 p-2 border rounded';
                
                const serviceName = service.service_name || '-';
                const serviceEnabled = service.service_enabled !== null && service.service_enabled !== undefined ? 
                    (service.service_enabled === 'enabled' ? '활성화' : '비활성화') : '비활성화';
                const serviceActive = service.service_active !== null && service.service_active !== undefined ? 
                    (service.service_active === 'active' ? '실행중' : '실행안됨') : '실행안됨';
                
                serviceDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong class="small">${serviceName}</strong>
                        <span class="badge ${serviceActive === '실행중' ? 'bg-success' : 'bg-secondary'}">${serviceActive}</span>
                    </div>
                    <p class="mb-0 small text-muted">상태: ${serviceEnabled}</p>
                `;
                
                serviceContainer.appendChild(serviceDiv);
            });
        } else {
            serviceContainer.innerHTML = '<p class="mb-1 small text-muted">서비스 정보 없음</p>';
        }
    }

    function clearAllDeviceInfo() {
        // system info
        document.getElementById('start-datetime').textContent = '-';
        document.getElementById('cpu-usage').textContent = '-';
        document.getElementById('cpu-temp').textContent = '-';
        updateProgressBar('cpu-usage-bar', 0);
        updateProgressBar('cpu-temp-bar', 0);
        
        // memory info
        document.getElementById('total-memory').textContent = '-';
        document.getElementById('used-memory').textContent = '-';
        document.getElementById('memory-usage').textContent = '-';
        updateProgressBar('memory-usage-bar', 0);
        
        // disk info
        document.getElementById('total-disk').textContent = '-';
        document.getElementById('used-disk').textContent = '-';
        document.getElementById('disk-usage').textContent = '-';
        updateProgressBar('disk-usage-bar', 0);
        
        // network info
        document.getElementById('connection-type').textContent = '-';
        document.getElementById('ssid-gateway').textContent = '-';
        document.getElementById('ip-address').textContent = '-';
        
        // service info
        document.getElementById('service-info').innerHTML = '<p class="mb-1 small text-muted">서비스 정보 없음</p>';
        
        // audio info
        document.getElementById('audio-status').textContent = '-';
        document.getElementById('audio-current').textContent = '-';
        document.getElementById('audio-volume').textContent = '-';

        audioVolumeButton.disabled = true;
        internetTestButton.disabled = true;
        audioPlayStopButton.disabled = true;
    }

    function updateDeviceStatus(status) {
        const hardwareInfo = status.hardware_info || {};
        const networkInfo = status.network_info || {};
        const serviceInfo = status.service_info || {};
        const audioInfo = status.audio_info || {};
        
        // system info
        document.getElementById('start-datetime').textContent = status.start_datetime || '-';
        const cpuUsages = Array.isArray(hardwareInfo.cpu_usages) ? hardwareInfo.cpu_usages : [];
        const cpuAvg = cpuUsages.length ? (cpuUsages.reduce((a, b) => a + b, 0) / cpuUsages.length) : null;
        document.getElementById('cpu-usage-avg').textContent = cpuAvg !== null ? cpuAvg.toFixed(1) : '-';
        document.getElementById('cpu-usages-list').innerHTML = cpuUsages.length 
            ? cpuUsages.map((v, i) => `<span class=\"cpu-core\">C${i+1}: ${v.toFixed(1)}%</span>`).join('')
            : '-';
        if (cpuAvg !== null) {
            updateProgressBar('cpu-usage-bar', cpuAvg);
        }
        
        const cpuTemp = hardwareInfo.cpu_temp !== undefined ? hardwareInfo.cpu_temp : null;
        document.getElementById('cpu-temp').textContent = cpuTemp !== null ? cpuTemp.toFixed(1) : '-';
        if (cpuTemp !== null) {
            updateProgressBar('cpu-temp-bar', cpuTemp);
        }
        
        // memory info
        const totalMemory = hardwareInfo.total_memory || 0;
        const usedMemory = hardwareInfo.used_memory || 0;
        const memoryUsagePercent = totalMemory > 0 ? ((usedMemory / totalMemory) * 100) : 0;
        document.getElementById('total-memory').textContent = filesize(totalMemory);
        document.getElementById('used-memory').textContent = filesize(usedMemory);
        document.getElementById('memory-usage').textContent = memoryUsagePercent.toFixed(1);
        updateProgressBar('memory-usage-bar', memoryUsagePercent);
        
        // disk info
        const totalDisk = hardwareInfo.total_disk || 0;
        const usedDisk = hardwareInfo.used_disk || 0;
        const diskUsagePercent = totalDisk > 0 ? ((usedDisk / totalDisk) * 100) : 0;
        document.getElementById('total-disk').textContent = filesize(totalDisk);
        document.getElementById('used-disk').textContent = filesize(usedDisk);
        document.getElementById('disk-usage').textContent = diskUsagePercent.toFixed(1);
        updateProgressBar('disk-usage-bar', diskUsagePercent);
        
        // network info
        document.getElementById('connection-type').textContent = networkInfo.connection_type || '-';
        document.getElementById('ssid-gateway').textContent = networkInfo.ssid_or_gateway || '-';
        document.getElementById('ip-address').textContent = networkInfo.ip || '-';
        
        // service info
        updateServiceInfo(serviceInfo);
        
        // audio info
        document.getElementById('audio-status').textContent = audioInfo.status || '-';
        document.getElementById('audio-current').textContent = audioInfo.current || '-';
        document.getElementById('audio-volume').textContent = audioInfo.volume || '-';

        internetTestButton.disabled = networkInfo.connection_type ? false : true;
        audioVolumeButton.disabled = audioInfo.status ? false : true;
        audioPlayStopButton.disabled = audioInfo.status ? false : true;
    }

    function refreshTerminalStatusInfo() {
        statusCountLabel.textContent = statusCount;
        lastUpdatedAtLabel.textContent = lastUpdatedAt === '없음' ? '없음' : lastUpdatedAt.toLocaleString();
        firstStatusTimeLabel.textContent = firstStatusTime === '없음' ? '없음' : firstStatusTime.toLocaleString();
        tdsLabel.textContent = filesize(tds);

        if (lastUpdatedAt !== '없음' && new Date() - lastUpdatedAt < 1000) {
            lastUpdatedAtLabel.textContent = lastUpdatedAtLabel.textContent + ' (방금전)';
        }
        if (lastUpdatedAt !== '없음' && new Date() - lastUpdatedAt > 10000) {
            lastUpdatedAtLabel.textContent = lastUpdatedAtLabel.textContent + ' (연결 끊김)';
        }
    }
    
    setInterval(() => {
        refreshTerminalStatusInfo();
    }, 1000);

    setInterval(() => {
        if (lastUpdatedAt !== '없음' && new Date() - lastUpdatedAt > 10000) {
            clearAllDeviceInfo();
        }
    }, 1000);
    
    socket.on('device_status', (status) => {
        tds += status.length;
        console.log(status);
        updateDeviceStatus(JSON.parse(status));
        lastUpdatedAt = new Date();
        statusCount++;
        if (firstStatusTime === '없음') {
            firstStatusTime = new Date();
        }
    });

    setStatusLabelText('connecting');
    socket.on('connect', () => setStatusLabelText('connected'));
    socket.on('disconnect', () => setStatusLabelText('disconnected'));
    socket.on('connect_error', () => setStatusLabelText('error'));
    if (socket.io && socket.io.on) {
        socket.io.on('reconnect_attempt', () => setStatusLabelText('connecting'));
        socket.io.on('reconnect_error', () => setStatusLabelText('error'));
        socket.io.on('reconnect_failed', () => setStatusLabelText('error'));
    }

    function changeTerminal(terminalId) {
        setTimeout(() => {
            statusCount = 0;
            firstStatusTime = '없음';
            lastUpdatedAt = '없음';
            refreshTerminalStatusInfo();
            document.getElementById('start-datetime').textContent = '-';
            document.getElementById('cpu-usage-avg').textContent = '-';
            document.getElementById('cpu-usages-list').textContent = '-';
            document.getElementById('cpu-temp').textContent = '-';
            document.getElementById('total-memory').textContent = '-';
            document.getElementById('used-memory').textContent = '-';
            document.getElementById('memory-usage').textContent = '-';
            document.getElementById('total-disk').textContent = '-';
            document.getElementById('used-disk').textContent = '-';
            document.getElementById('disk-usage').textContent = '-';
            document.getElementById('connection-type').textContent = '-';
            document.getElementById('ssid-gateway').textContent = '-';
            document.getElementById('ip-address').textContent = '-';
            document.getElementById('service-info').innerHTML = '<p class="mb-1 small text-muted">서비스 정보 없음</p>';
            document.getElementById('audio-status').textContent = '-';
            document.getElementById('audio-current').textContent = '-';
            document.getElementById('audio-volume').textContent = '-';

            updateProgressBar('cpu-usage-bar', 0);
            updateProgressBar('cpu-temp-bar', 0);
            updateProgressBar('memory-usage-bar', 0);
            updateProgressBar('disk-usage-bar', 0);

            internetTestButton.disabled = true;
            audioVolumeButton.disabled = true;
            audioPlayStopButton.disabled = true;
        }, 100);
        socket.emit('leave_terminal', selectedTerminalId || null);

        selectedTerminalId = terminalId;
        socket.emit('join_terminal', selectedTerminalId);
        
        const terminalSelect = document.querySelector('select[onchange="changeTerminal(this.value)"]');
        const selectedOption = terminalSelect.options[terminalSelect.selectedIndex];
        document.getElementById('selected-terminal-name').textContent = selectedOption.textContent;
    }

    function sendCommandShutdown() {
        if (!confirm('시스템을 정말 종료하시겠습니까?\n종료 후 다시 사용하려면, 수동으로 전원을 끈 후 다시 키십시오.')) return;

        sendCommand('shutdown');
    }

    function sendCommandSpeak() {
        const text = prompt('말할 내용을 입력하십시오:');
        if (!text) return;

        sendCommand('speak'+text);
    }

    function sendCommandVolume() {
        const volume = prompt('볼륨을 입력하십시오(0~100):');
        if (!volume) return;

        sendCommand('volume'+volume);
    }

    function sendCommandCheck() {
        if (!confirm('테스트 신호가 전송됩니다.\n30초 이내 소리가 나지 않을 경우 인터넷 연결을 확인하십시오.')) return;

        sendCommand('internet');
    }

    function sendCommand(command) {
        if (!selectedTerminalId) {
            alert('터미널을 선택하십시오.');
            return;
        }
        
        if (confirm(`명령을 전송하시겠습니까?`)) {
            socket.emit('command', {
                command: command,
                terminal_id: parseInt(selectedTerminalId)
            });
            console.log(`command sent.\nterminal_id: ${selectedTerminalId}, command: ${command}`);
            alert(`명령을 전송했습니다.`);
        }
    }
</script>
{% endblock scripts %}