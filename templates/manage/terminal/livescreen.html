{% extends "base.html" %}

{% block body %}
<div class="container">
    <div class="d-flex justify-content-between">
        <div>
            <h3>단말기 화면 열람</h3>
        </div>
        <div class="align-self-end">
        </div>
    </div>
    {% if terminal_list.success %}
        <select class="form-select" aria-label="Default select example" onchange="changeTerminal(this.value)">
            <option value="" selected disabled>Select Terminal</option>
            {% for terminal in terminal_list.data %}
                <option value="{{ terminal.id }}" {% if terminal.status != 'active' %}disabled{% endif %}>{{ terminal.name }}{% if terminal.status != 'active' %}&#40;사용불가&#41;{% endif %}</option>
            {% endfor %}
        </select>
    {% else %}
        <div class="alert alert-danger">
            {{ terminal_list.message }}
        </div>
    {% endif %}
    <div class="mt-3">
        <div>
            연결상태: <span id="status-label">연결 안됨</span>
        </div>
    </div>
    <hr>
    <div id="terminal-live-screen-info" class="d-flex justify-content-end">
        <span>최초연결:&nbsp;<span id="first-frame-time-label"></span>&nbsp;|&nbsp;<span>최종수신:&nbsp;<span id="last-updated-at-label"></span></span>&nbsp;|&nbsp;<span>FPS:&nbsp;<span id="fps-label"></span></span>&nbsp;|&nbsp;<span>BPS:&nbsp;<span id="bps-label"></span></span>&nbsp;|&nbsp;<span>TDS:&nbsp;<span id="total-data-size-label"></span></span>
    </div>
    <div id="terminal-live-screen" class="d-flex justify-content-center bg-light p-3 border rounded">
        <img id="live-screen" alt="화면을 볼 단말기를 선택하십시오." style="width: 100%; height: auto; display: block; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;"> <!-- Disable AA -->
    </div>
    
</div>
{% endblock body %}

{% block scripts %}
<script type="text/javascript" src="{{ url_for('static', filename='assets/socket.io.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='assets/filesize.min.js') }}"></script>
<script>
    let selectedTerminalId = '';
    let fpsCount = 0;
    let bpsCount = 0;
    let totalDataSize = 0;
    let firstFrameTime = '없음';
    let lastUpdatedAt = '없음';
    const screen = document.getElementById('live-screen');
    const statusLabel = document.getElementById('status-label');
    const fpsLabel = document.getElementById('fps-label');
    const totalDataSizeLabel = document.getElementById('total-data-size-label');
    const firstFrameTimeLabel = document.getElementById('first-frame-time-label');
    const lastUpdatedAtLabel = document.getElementById('last-updated-at-label');
    const bpsLabel = document.getElementById('bps-label');

    const socket = io('/terminal/livescreen');

    function setStatusLabelText(status) {
        statusLabel.textContent = status;
    }

    function refreshTerminalLiveScreenInfo() {
        fpsLabel.textContent = fpsCount;
        bpsLabel.textContent = filesize(fpsCount !== 0 ? bpsCount/fpsCount : 0);
        totalDataSizeLabel.textContent = filesize(totalDataSize);
        lastUpdatedAtLabel.textContent = lastUpdatedAt.toLocaleString();
        
        firstFrameTimeLabel.textContent = firstFrameTime.toLocaleString();
        if (lastUpdatedAt && new Date() - lastUpdatedAt < 1000) {
            lastUpdatedAtLabel.textContent = lastUpdatedAtLabel.textContent + ' (방금전)';
        }
        if (lastUpdatedAt && new Date() - lastUpdatedAt > 10000) {
            lastUpdatedAtLabel.textContent = lastUpdatedAtLabel.textContent + ' (연결 끊김)';
        }
    }
    
    setInterval(() => {
        refreshTerminalLiveScreenInfo();
        fpsCount = 0;
        bpsCount = 0;
    }, 1000);

    setInterval(() => {
        if (lastUpdatedAt && new Date() - lastUpdatedAt > 5000) {
            screen.src = '';
        }
    }, 1000);
    
    socket.on('livescreen', (base64Data) => {
        screen.src = `data:image/webp;base64,${base64Data}`;

        lastUpdatedAt = new Date();
        fpsCount++;
        bpsCount += base64Data.length;
        totalDataSize += base64Data.length;
    });


    setStatusLabelText('connecting');
    socket.on('connect', () => setStatusLabelText('connected'));
    socket.on('disconnect', () => setStatusLabelText('disconnected'));
    socket.on('connect_error', () => setStatusLabelText('error'));
    if (socket.io && socket.io.on) {
        socket.io.on('reconnect_attempt', () => setStatusLabelText('connecting'));
        socket.io.on('reconnect_error', () => setStatusLabelText('error'));
        socket.io.on('reconnect_failed', () => setStatusLabelText('error'));
    }

    function changeTerminal(terminalId) {
        setTimeout(() => {
            fpsCount = 0;
            bpsCount = 0;
            firstFrameTime = new Date();
            lastUpdatedAt = '없음';
            refreshTerminalLiveScreenInfo();
            screen.alt = '표시할 화면이 없습니다.';
            screen.src = '';
        }, 100);
        socket.emit('leave_terminal', selectedTerminalId || null);

        selectedTerminalId = terminalId;
        socket.emit('join_terminal', selectedTerminalId);
    }
</script>
{% endblock scripts %}